warning: in the working copy of 'controllers/messageController.js', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/controllers/messageController.js b/controllers/messageController.js[m
[1mindex 34f712b..ec32f49 100644[m
[1m--- a/controllers/messageController.js[m
[1m+++ b/controllers/messageController.js[m
[36m@@ -112,8 +112,11 @@[m [mexport const getUsersForSidebar = async (req, res) => {[m
        await Promise.all(promises);[m
        res.json({success: true, users: filteredUsers, unseenMessages, lastMessages});[m
     } catch (error) {[m
[31m-        console.log(error);[m
[31m-        res.json({success: false, message: error.message});[m
[32m+[m[32m        console.error('‚ùå [getUsersForSidebar] –û—à–∏–±–∫–∞:', error.message);[m
[32m+[m[32m        res.status(500).json({[m
[32m+[m[32m            success: false,[m[41m [m
[32m+[m[32m            message: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'[m
[32m+[m[32m        });[m
     }[m
 }[m
 [m
[36m@@ -123,6 +126,14 @@[m [mexport const getMessages = async (req, res) => {[m
         const {id:selectedUserId} = req.params;[m
         const myId = req.user._id;[m
 [m
[32m+[m[32m        // ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –í–∞–ª–∏–¥–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è[m
[32m+[m[32m        if (!selectedUserId || !selectedUserId.match(/^[0-9a-fA-F]{24}$/)) {[m
[32m+[m[32m            return res.status(400).json({[m
[32m+[m[32m                success: false,[m
[32m+[m[32m                message: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
         console.log(`üì® [getMessages] –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${selectedUserId} –æ—Ç ${myId}`);[m
 [m
         const messages = await Message.find({[m
[36m@@ -136,7 +147,24 @@[m [mexport const getMessages = async (req, res) => {[m
         // –≠—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ—á—Ç–µ–Ω–∏–∏[m
 [m
         // E2EE: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –µ—Å—Ç—å, —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ[m
[31m-        const processedMessages = messages.map(message => message.toObject());[m
[32m+[m[32m        const processedMessages = messages.map(message => {[m
[32m+[m[32m            const msgObj = message.toObject();[m
[32m+[m[41m            [m
[32m+[m[32m            // –õ–æ–≥–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏[m
[32m+[m[32m            if (msgObj.audio) {[m
[32m+[m[32m                console.log(`üé§ [getMessages] –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:`, {[m
[32m+[m[32m                    id: msgObj._id,[m
[32m+[m[32m                    encrypted: msgObj.encrypted,[m
[32m+[m[32m                    hasBlob: !!msgObj.encryptedBlob,[m
[32m+[m[32m                    // ‚úÖ –î–ª—è E2EE: –¥–∞–Ω–Ω—ã–µ –∞—É–¥–∏–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º blob[m
[32m+[m[32m                    // audio –∏ audioDuration –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏ –¥–ª—è E2EE —Å–æ–æ–±—â–µ–Ω–∏–π[m
[32m+[m[32m                    audioInBlob: msgObj.encrypted ? '–≤ blob' : msgObj.audio,[m
[32m+[m[32m                    durationInBlob: msgObj.encrypted ? '–≤ blob' : msgObj.audioDuration[m
[32m+[m[32m                });[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            return msgObj;[m
[32m+[m[32m        });[m
 [m
         // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞[m
         const user = await User.findById(myId);[m
[36m@@ -233,13 +261,46 @@[m [mexport const deleteChatWithUser = async (req, res) => {[m
 // Send a message to selected user[m
 export const sendMessage = async (req, res) => {[m
     try {[m
[31m-        const{text, blob, audio, audioDuration} = req.body; // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É blob, audio, audioDuration[m
[32m+[m[32m        // üîê –í–ê–õ–ò–î–ê–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ[m
[32m+[m[32m        const {text, blob, audio, audioDuration} = req.body;[m
         const receiverId = req.params.id;[m
         const senderId = req.user._id;[m
 [m
[32m+[m[32m        // ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –í–∞–ª–∏–¥–∞—Ü–∏—è ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è[m
[32m+[m[32m        if (!receiverId || !receiverId.match(/^[0-9a-fA-F]{24}$/)) {[m
[32m+[m[32m            return res.status(400).json({[m
[32m+[m[32m                success: false,[m
[32m+[m[32m                message: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è'[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ[m
[32m+[m[32m        if (receiverId === senderId.toString()) {[m
[32m+[m[32m            return res.status(400).json({[m
[32m+[m[32m                success: false,[m
[32m+[m[32m                message: '–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∞–º–æ–º—É —Å–µ–±–µ'[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö[m
[32m+[m[32m        if (text && text.length > 10000) {[m
[32m+[m[32m            return res.status(400).json({[m
[32m+[m[32m                success: false,[m
[32m+[m[32m                message: '–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ'[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        // ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –í–∞–ª–∏–¥–∞—Ü–∏—è –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö[m
[32m+[m[32m        if (audioDuration && (audioDuration < 0 || audioDuration > 300000)) { // 5 –º–∏–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º[m
[32m+[m[32m            return res.status(400).json({[m
[32m+[m[32m                success: false,[m
[32m+[m[32m                message: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—É–¥–∏–æ'[m
[32m+[m[32m            });[m
[32m+[m[32m        }[m
[32m+[m
         console.log(`üì§ [sendMessage] –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç ${senderId} –∫ ${receiverId}`);[m
         if (audio) {[m
[31m-            console.log(`üé§ [sendMessage] –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${audio}, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${audioDuration}ms`);[m
[32m+[m[32m            console.log(`üé§ [sendMessage] –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ`);[m
         }[m
 [m
         let imageUrl = null;[m
[36m@@ -248,6 +309,7 @@[m [mexport const sendMessage = async (req, res) => {[m
         // E2EE: –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª blob, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å –±–µ–∑ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏[m
         if(blob) {[m
             console.log(`üîê [sendMessage] –ü–æ–ª—É—á–µ–Ω E2EE blob –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞`);[m
[32m+[m[32m            // ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û: –ù–µ –ª–æ–≥–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ blob[m
             messageData = blob;[m
         }[m
         else if(text && text.trim()) {[m
[36m@@ -255,13 +317,26 @@[m [mexport const sendMessage = async (req, res) => {[m
             messageData = text;[m
         }[m
 [m
[31m-        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å[m
[32m+[m[32m        // ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å[m
         if (req.file) {[m
[31m-            console.log(`üì∑ [sendMessage] –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:`, {[m
[31m-                originalname: req.file.originalname,[m
[31m-                mimetype: req.file.mimetype,[m
[31m-                size: req.file.size[m
[31m-            });[m
[32m+[m[32m            // ‚úÖ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞[m
[32m+[m[32m            if (req.file.size > 10 * 1024 * 1024) { // 10MB –º–∞–∫—Å–∏–º—É–º[m
[32m+[m[32m                return res.status(